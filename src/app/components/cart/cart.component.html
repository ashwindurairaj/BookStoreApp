<div class="cart-container" *ngIf="cartItems.length > 0; else noCart">
  <p class="breadcrumb"><a routerLink="/home">Home</a> / <b>My cart</b></p>

  <div class="cart-header">
    <h3>My Cart ({{ cartItems.length }})</h3>
    <div class="location-selector">
      <mat-icon>location_on</mat-icon>
      Use current location
      <mat-icon>expand_more</mat-icon>
    </div>
  </div>

  <div class="cart-item bordered-box" *ngFor="let item of cartItems">
    <img src="assets/book.png" alt="Book Image" />
    <div class="item-details">
      <h4>{{ item.product_id.bookName }}</h4>
      <p class="author">by {{ item.product_id.author }}</p>
      <div class="price">
        <span class="sale-price">Rs. {{ item.product_id.discountPrice }}</span>
        <span class="original-price">Rs. {{ item.product_id.price }}</span>
      </div>
      <div class="quantity-control">
        <button mat-icon-button class="addBtn" (click)="decrementQuantity(item)">
          <mat-icon>remove</mat-icon>
        </button>
        <span>{{ item.quantityToBuy }}</span>
        <button mat-icon-button class="addBtn" (click)="incrementQuantity(item)">
          <mat-icon>add</mat-icon>
        </button>
        <a class="remove-link" (click)="removeFromCart(item._id)">Remove</a>
      </div>
    </div>
  </div>

  <div class="action-button" *ngIf="!showCustomerDetails && !showSummary">
    <button mat-raised-button color="primary" class="continue-button" (click)="showCustomerDetails = true">
      PROCEED TO CUSTOMER DETAILS
    </button>
  </div>

  <div *ngIf="showCustomerDetails" class="customer-details bordered-box">
    <h3>Customer Details</h3>

    <!-- Display saved addresses if available -->
    <div *ngIf="addresses.length > 0">
      <h4>Select a saved address:</h4>
      <div *ngFor="let address of addresses; let i = index" class="saved-address">
        <div class="address-item">
          <mat-radio-button [checked]="selectedAddressIndex === i" (click)="selectAddress(i)">
            {{ address.type }}: {{ address.address }}, {{ address.city }}, {{ address.state }}
          </mat-radio-button>

          <mat-icon class="delete-icon" (click)="deleteAddress(i)">delete</mat-icon>
        </div>
      </div>
      <hr>
      <h4>Or add a new address:</h4>
    </div>

    <div class="customer-fields">
      <div>
        <label>Full Name</label>
        <input [value]="userName" disabled />
      </div>
      <div>
        <label>Mobile Number</label>
        <input [value]="userPhone" disabled />
      </div>
    </div>

    <div class="customer-field">
      <label>Address</label>
      <textarea [(ngModel)]="newAddress.address" placeholder="Enter your address"></textarea>
    </div>

    <div class="customer-fields">
      <div>
        <label>City/Town</label>
        <input [(ngModel)]="newAddress.city" placeholder="Enter your city" />
      </div>
      <div>
        <label>State</label>
        <input [(ngModel)]="newAddress.state" placeholder="Enter your state" />
      </div>
    </div>

    <div>
      <label>Type</label>
      <mat-radio-group [(ngModel)]="newAddress.type">
        <mat-radio-button value="Home">Home</mat-radio-button>
        <mat-radio-button value="Work">Work</mat-radio-button>
        <mat-radio-button value="Other">Other</mat-radio-button>
      </mat-radio-group>
    </div>

    <!-- Optional: Keep the save button for explicit saving -->
    <div class="action-button">
      <button mat-stroked-button color="primary" (click)="saveAddress()">
        SAVE THIS ADDRESS
      </button>
    </div>

    <div class="action-button" *ngIf="showCustomerDetails && !showSummary">
      <button mat-raised-button color="primary" class="continue-button" (click)="continueToSummary()">
        CONTINUE TO SUMMARY
      </button>
    </div>
  </div>

  <div class="order-summary bordered-box" *ngIf="showSummary">
    <h3>Order Summary</h3>

    <div *ngFor="let item of cartItems" class="summary-item">
      <img src="assets/book.png" alt="Book Image" />
      <div>
        <h4>{{ item.product_id.bookName }}</h4>
        <p class="author">by {{ item.product_id.author }}</p>
        <span class="sale-price">Rs. {{ item.product_id.discountPrice }}</span>
        <span class="quantity"> | Quantity: {{ item.quantityToBuy }}</span>
      </div>
    </div>

    <div class="delivery-address">
      <h4>Delivery Address:</h4>
      <p>{{ userType }}: {{ userAddress }}, {{ userCity }}, {{ userState }}</p>
    </div>

    <div class="total-section">
      <h4>Total: Rs. {{ getTotalPrice() }}</h4>
    </div>

    <div class="action-button" *ngIf="showSummary">
      <button mat-raised-button color="primary" class="checkout-button" (click)="orderNow()">
        PLACE ORDER
      </button>
    </div>
  </div>
</div>

<ng-template #noCart>
  <div class="empty-cart">
    <mat-icon>shopping_cart</mat-icon>
    <h3>Your cart is empty</h3>
    <p>Add some books to get started!</p>
    <button mat-raised-button color="primary" routerLink="/home">Continue Shopping</button>
  </div>
</ng-template>